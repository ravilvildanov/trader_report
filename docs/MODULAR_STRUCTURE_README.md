# Модульная структура кода

## Обзор

Код был разделён на модули для лучшей организации, читаемости и поддерживаемости. Каждый класс теперь находится в отдельном файле с чётко определённой ответственностью.

## Структура модулей

```
FreedomCalculator/
├── src/                           # Пакет с модулями
│   ├── __init__.py               # Инициализация пакета
│   ├── font_manager.py           # Управление шрифтами
│   ├── data_loaders.py           # Загрузчики данных (Excel/PDF)
│   ├── currency_rates_loader.py  # Загрузка курсов валют
│   ├── trade_data_processor.py   # Обработка торговых данных
│   ├── trade_summary_calculator.py # Вычисление сводок
│   ├── negative_balance_handler.py # Обработка отрицательного сальдо
│   ├── pdf_report_generator.py   # Генерация PDF отчётов
│   └── trade_report_processor.py # Основной координатор
├── main.py                       # Точка входа в приложение
├── process_trades_refactored.py  # Монолитный рефакторенный код
└── process_trades.py             # Оригинальный код
```

## Описание модулей

### 1. `src/font_manager.py`
**Класс:** `FontManager`
**Ответственность:** Управление шрифтами для поддержки кириллицы в PDF отчётах
**Функции:**
- Автоматический поиск и регистрация шрифтов
- Fallback на стандартные шрифты при отсутствии кастомных

### 2. `src/data_loaders.py`
**Классы:** `DataLoader`, `ExcelDataLoader`, `PDFDataLoader`, `DataLoaderFactory`
**Ответственность:** Загрузка данных из различных источников
**Функции:**
- Абстрактный интерфейс для загрузчиков
- Реализация для Excel файлов
- Реализация для PDF файлов
- Фабрика для создания соответствующих загрузчиков

### 3. `src/currency_rates_loader.py`
**Класс:** `CurrencyRatesLoader`
**Ответственность:** Загрузка и обработка курсов валют
**Функции:**
- Загрузка курсов из Excel файла
- Фильтрация по валюте (доллар США)
- Нормализация данных

### 4. `src/trade_data_processor.py`
**Класс:** `TradeDataProcessor`
**Ответственность:** Обработка торговых данных
**Функции:**
- Нормализация операций
- Объединение с курсами валют
- Вычисление сумм в рублях

### 5. `src/trade_summary_calculator.py`
**Класс:** `TradeSummaryCalculator`
**Ответственность:** Вычисление сводок по торговым данным
**Функции:**
- Расчёт сводки по тикерам
- Вычисление закрытых позиций
- Формирование итоговых данных

### 6. `src/negative_balance_handler.py`
**Класс:** `NegativeBalanceHandler`
**Ответственность:** Обработка тикеров с отрицательным сальдо
**Функции:**
- Выявление тикеров с отрицательным сальдо
- Загрузка данных прошлого периода
- Обработка отрицательного баланса

### 7. `src/pdf_report_generator.py`
**Класс:** `PDFReportGenerator`
**Ответственность:** Генерация PDF отчётов
**Функции:**
- Создание отчётов по закрытым позициям
- Форматирование таблиц и стилей
- Ограничение размера таблиц для предотвращения переполнения

### 8. `src/trade_report_processor.py`
**Класс:** `TradeReportProcessor`
**Ответственность:** Координация всех компонентов
**Функции:**
- Инициализация всех модулей
- Управление процессом обработки
- Сохранение результатов

### 9. `main.py`
**Ответственность:** Точка входа в приложение
**Функции:**
- Парсинг аргументов командной строки
- Создание и запуск процессора
- Обработка ошибок

## Преимущества модульной структуры

### 1. **Разделение ответственности**
- Каждый модуль отвечает за конкретную функциональность
- Легко понять, где искать нужный код

### 2. **Улучшенная читаемость**
- Меньше кода в каждом файле
- Логическая группировка связанного функционала

### 3. **Лучшая тестируемость**
- Каждый модуль можно тестировать независимо
- Простое создание mock-объектов для тестов

### 4. **Переиспользование**
- Модули можно использовать в других проектах
- Легко импортировать только нужную функциональность

### 5. **Поддерживаемость**
- Изменения в одном модуле не влияют на другие
- Простое добавление новых функций

### 6. **Масштабируемость**
- Легко добавлять новые модули
- Простое расширение существующей функциональности

## Использование

### Запуск приложения
```bash
python main.py broker_report.xlsx currency_rates.xlsx [previous_report.xlsx] [--out output_dir]
```

### Импорт отдельных модулей
```python
from src.font_manager import FontManager
from src.data_loaders import ExcelDataLoader
from src.trade_data_processor import TradeDataProcessor

# Использование
font_manager = FontManager()
excel_loader = ExcelDataLoader()
processor = TradeDataProcessor('USD')
```

### Создание собственных загрузчиков
```python
from src.data_loaders import DataLoader

class CustomDataLoader(DataLoader):
    def load(self, file_path: Path) -> pd.DataFrame:
        # Ваша реализация
        pass
```

## Совместимость

Модульная версия полностью совместима с монолитной по функциональности. Все результаты идентичны, но код теперь лучше организован и легче поддерживается.

## Миграция

Для перехода с монолитного кода на модульный достаточно заменить:
```python
# Было
from process_trades_refactored import TradeReportProcessor

# Стало
from src.trade_report_processor import TradeReportProcessor
```

## Разработка

При добавлении новой функциональности:
1. Определите, к какому модулю относится новая функция
2. Добавьте её в соответствующий модуль
3. При необходимости создайте новый модуль
4. Обновите импорты в `trade_report_processor.py`

Эта структура делает код более профессиональным и готовым для production использования!
